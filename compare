#!/usr/bin/env ruby

require 'digest/sha1'

INFILE = ARGV[0] or begin
  puts "Must specify input file"
  exit 1
end

SCRIPTS = [
  './bin/haskell/munge < {in}',
  './bin/c/munge < {in}',
  'ruby src/ruby/munge.rb < {in}'
]

VARIANTS = {
  'single' => 'time {script} | pv > {out}',
  'parallel' => 'time parallel --keep-order --pipe {script} | pv > {out}'
}

def run(cmd)
  puts cmd
  system cmd
end

def parse_template(template, script_path, in_path, out_path)
  template.
    gsub('{script}', script_path).
    gsub('{in}', in_path).
    gsub('{out}', out_path)
end

def compare_output_files(outfiles)
  md5s = outfiles.map do |outfile|
    md5 = `md5 -q #{outfile}`.chomp
    puts "#{md5} - #{outfile}"
    md5
  end

  if md5s.uniq.size == 1
    puts "All the same!"
  else
    puts "ERROR: Some output files differ"
  end
end

def script_id(script)
  Digest::SHA1.hexdigest(script)
end

def setup_output_path(in_path, script, variant)
  out_dir = File.join 'output', script_id(script), variant
  out_path = File.join out_dir, File.basename(in_path)
  `mkdir -p #{out_dir}`
  out_path
end

def run_benchmarks(scripts, variants, in_path)
  out_paths = []
  scripts.each do |script|
    puts "Running benchmarks for script: #{script}"
    variants.each do |variant, template|
      out_paths << out_path = setup_output_path(in_path, script, variant)
      puts "Running variant: #{variant}"
      cmd = parse_template(template, script, in_path, out_path)
      run cmd
    end
    puts "-" * 100
  end
  
  puts "Comparing output files..."
  compare_output_files(out_paths)
end

run_benchmarks(SCRIPTS, VARIANTS, INFILE)